{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load display_shortcuts %}
{% block extra_headers %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.formset/1.2.2/jquery.formset.min.js"></script>
{% endblock %}
{% block body_content %}



{% block event_extra_btns %}
{% endblock %}

<div class="modal hide" id="eventModal">
</div>

<div class="container">
    <div class="card">
        <div class="card-header">
            {{ form.instance.name }}&nbsp;-&nbsp;{% block type_element %}{{ form.instance|get_class }}{% endblock %}
        </div>
        <div class="card-body">


<nav class="nav nav-tabs">
  <a class="nav-item nav-link active" href="#main" data-toggle="tab">Element</a>
  <a class="nav-item nav-link" href="#location" data-toggle="tab">Locations</a>
  <a class="nav-item nav-link" href="#buy" data-toggle="tab">Buy History</a>
  <a class="nav-item nav-link" href="#sell" data-toggle="tab">Sell History</a>
  <a class="nav-item nav-link" href="#borrow" data-toggle="tab">Borrow History</a>
  <a class="nav-item nav-link" href="#reservation" data-toggle="tab">Reservation History</a>
  <a class="nav-item nav-link" href="#consume" data-toggle="tab">Consume History</a>
  {% block extra_event_tabs%}{% endblock %}
</nav>
<div class="tab-content">
    <div class="tab-pane active" id="main">
        <a href="/element/barcode/{{ form.instance.id }}">Barcode</a>
         <a class="btn btn-primary" href="/element/print/add/{{ form.instance.id }}/1" role="button">Add one to print list !</a>
         {% if form.instance.image %}
         <a href="{{form.instance.image.url}}"><img width=100px src="{{ form.instance.image.url }}"/></a>
         {% endif %}
        <form enctype="multipart/form-data" method="post">
        {% csrf_token %}
        <table>

            {{ form.as_p }}

            {{ attributes.management_form }}

            {% for attribute in attributes %}
             <tr class="link-formset">
                {% for field in attribute %}
                    <td>
                        {{ field }}
                    </td>
                {% endfor %}
            </tr>
            {% endfor %}

            {{ attachments.management_form }}

            {% for attachment in attachments %}
             <tr class="link-formset-attachment">
                {% for field in attachment %}
                    <td>
                        {{ field }}
                    </td>
                {% endfor %}
            </tr>
            {% endfor %}


        </table>
            {% if  request.resolver_match.kwargs.pk %}
            <input type="submit" value="Update">
            {% else %}
            <input type="submit" value="Save">
            {% endif %}
        </form>

    </div>

    <div class="tab-pane" id="location">

<button type="button" class="btn btn-primary event" href="#" data-form="/formbuyeventmodal?element={{form.instance.id}}" title="Buy"
{% if not perms.Mindkeepr.add_buyevent or form.instance.is_unique_and_there %}disabled{% endif %}>Buy</button>
    <table>
<tr><th>Location</th><th>Quantity</th><th>Project</th><th>Borrow</th><th>Reserve</th>{% if form.instance.is_consummable %}<th>Consume</th>{% endif %}<th>Sell</th><th>Move</th>
</tr>
{% for rep in form.instance.stock_repartitions.all|dictsort:"location.name" %}
<tr>
    <td><a href="/location/{{rep.location.id}}">{{rep.location.name}}</a></td>
    <td>{{rep.quantity}}</td>
    <td>{% if rep.project %}<a href="/project/{{rep.project.id}}">{{rep.project}}</a>{% else %}-{% endif %}</td>
    <td><button type="button" class="btn btn-primary event" href="#" data-form="/formborroweventmodal?element={{form.instance.id}}&locationsrc={{rep.location.id}}&quantity={{rep.quantity}}" title="Borrow" {% if "FREE" != rep.status or not perms.Mindkeepr.add_borrowevent %}disabled{% endif %}>Borrow</button></td>
    {% if not rep.project %}
    <td><button type="button" class="btn btn-primary event" href="#" data-form="/formuseeventmodal?element={{form.instance.id}}&locationsrc={{rep.location.id}}&quantity={{rep.quantity}}" title="Reserve" {% if "FREE" != rep.status  or not perms.Mindkeepr.add_useevent %}disabled{% endif %}>Reserve</button></td>
    {% else %}
    <td><button type="button" class="btn btn-primary event" href="#" data-form="/formunuseeventmodal?element={{form.instance.id}}&locationsrc={{rep.location.id}}&quantity={{rep.quantity}}{% if rep.project %}&project={{rep.project.id}}{% else %}&project=0{% endif %}" title="Unreserve" {% if "RESERVED" != rep.status or not perms.Mindkeepr.add_unuseevent%}disabled{% endif %}>Unreserve</button></td>
    {% endif %}
    {% if form.instance.is_consummable %}
    <td><button type="button" class="btn btn-primary event" href="#" data-form="/formconsumeeventmodal?element={{form.instance.id}}&locationsrc={{rep.location.id}}&quantity={{rep.quantity}}{% if rep.project %}&project={{rep.project.id}}{% else %}&project=0{% endif %}" title="Consume" {% if not perms.Mindkeepr.add_consumeevent or not rep.element.is_consummable %}disabled{% endif %}>Consume</button></td>
    {% endif %}
    <td><button type="button" class="btn btn-primary event" href="#" data-form="/formselleventmodal?element={{form.instance.id}}&locationsrc={{rep.location.id}}&quantity={{rep.quantity}}" title="Sell" {% if "FREE" != rep.status  or not perms.Mindkeepr.add_sellevent %}disabled{% endif %} >Sell</button></td>
    <td><button type="button" class="btn btn-primary event" href="#" data-form="/formmoveeventmodal?element={{form.instance.id}}&locationsrc={{rep.location.id}}&quantity={{rep.quantity}}{% if rep.project %}&project={{rep.project.id}}{% else %}&project=0{% endif %}&status={{rep.status}}" title="Move"  {% if not perms.Mindkeepr.add_moveevent %}disabled{% endif %}>Move</button></td>


</tr>
{% endfor %}
</table>
    </div>

  <div class="tab-pane" id="buy">

<table>
<tr>
<th>Date</th><th>Quantity</th><th>Price</th><th>Supplier</th><th>Destination</th><th>Comment</th><th>User</th>
</tr>
{% for buy in form.instance.buy_history.all %}
<tr>
    <td>{{buy.recording_date}}</td>
    <td>{{buy.quantity}}</td>
    <td>{{buy.price}}</td>
    <td>{{buy.supplier}}</td>
    <td><a href="/location/{{buy.location_destination.id}}">{{buy.location_destination.name}}</a></td>
    <td>{{buy.comment}}</td>
    <td>{{buy.creator.get_full_name}}</td>

</tr>
{% endfor %}
</table>
  </div>

  <div class="tab-pane" id="sell">

<table>
<tr><th>Date</th><th>Quantity</th><th>Price</th><th>Source</th><th>Comment</th><th>User</th>
</tr>
{% for sell in form.instance.sell_history.all %}
<tr>
    <td>{{sell.recording_date}}</td>
    <td>{{sell.quantity}}</td>
    <td>{{sell.price}}</td>
    <td><a href="/location/{{sell.location_source.id}}">{{sell.location_source.name}}</a></td>
    <td>{{sell.comment}}</td>
    <td>{{sell.creator.get_full_name}}</td>
</tr>
{% endfor %}
</table>
  </div>


  <div class="tab-pane" id="borrow">
  <table>
    <tr>
    <th>Date</th><th>Quantity</th><th>Scheduled return date</th><th>Source</th><th>Comment</th><th>User</th><th>Returned on</th><th>Returned in</th><th>Comment</th><th>Returned by</th><th>Return</th>
    </tr>

    {% for borrow in form.instance.borrow_history.all %}
    <tr>
        <td>{{borrow.recording_date}}</td>
        <td>{{borrow.quantity}}</td>
        <td>{{borrow.scheduled_return_date}}</td>
        <td><a href="/location/{{borrow.location_source.id}}">{{borrow.location_source.name}}</a></td>
        <td>{{borrow.comment}}</td>
        <td>{{borrow.creator.get_full_name}}</td>
        <td>{{ borrow.return_event.recording_date }} {% if borrow.return_event %}{% if borrow.return_event.is_date_overdue %}(LATE){% else %}(IN TIME){% endif %}{% endif %} </td>
        <td>{{ borrow.return_event.location_destination }}</td>
        <td>{{ borrow.return_event.comment }}</td>
        <td>{{ borrow.return_event.creator.get_full_name }}</td>
        <td><button type="button" class="btn btn-primary event" href="#" data-form="/formreturneventmodal?borrow={{borrow.id}}" title="Return" {% if borrow.return_event %}disabled{% endif %} >Return</button></td>
    </tr>
    {% endfor %}
    </table>
  </div>
  <div class="tab-pane" id="reservation">
    <table>
        <tr>
        <th>Date</th><th>Quantity</th><th>Source</th><th>Destination</th><th>Comment</th><th>User</th>
        </tr>

        {% for use in form.instance.use_history.all %}
        <tr>
            <td>{{use.recording_date}}</td>
            <td>{{use.quantity}}</td>
            <td><a href="/location/{{use.location_source.id}}">{{use.location_source.name}}</a></td>
            <td><a href="/location/{{use.location_destination.id}}">{{use.location_destination.name}}</a></td>
            <td>{{use.comment}}</td>
            <td>{{use.creator.get_full_name}}</td>
        </tr>
        {% endfor %}
    </table>
  </div>
  <div class="tab-pane" id="consume">
    <table>
    <tr><th>Date</th><th>Quantity</th><th>Source</th><th>Comment</th><th>User</th></tr>

    {% for consume in form.instance.consume_history.all %}
    <tr>
        <td>{{consume.recording_date}}</td>
        <td>{{consume.quantity}}</td>
        <td><a href="/location/{{consume.location_source.id}}">{{consume.location_source.name}}</a></td>
        <td>{{consume.comment}}</td>
        <td>{{consume.creator.get_full_name}}</td>
    </tr>
    {% endfor %}
    </table>
  </div>
{% block extra_event_tabs_content%}{% endblock %}
</div>








        </div>

    </div>
</div>














<script type="text/javascript">

// TODO : Add icons
        $('.link-formset').formset({
            addText: 'Add Attribute',
            deleteText: 'Remove',
            prefix: 'attributes',
        });
        $('.link-formset-attachment').formset({
            addText: 'Add Attachment',
            deleteText: 'Remove',
            prefix: 'attachments',
        });
</script>
<script>
    $(".event").click(function(ev) { // for each edit contact url
        ev.preventDefault(); // prevent navigation
        var url = $(this).data("form"); // get the contact form url
        $("#eventModal").load(url, function() { // load the url into the modal
            $(this).modal('show'); // display the modal on url load


        });
        return false; // prevent the click propagation
    });


</script>
{% endblock %}
